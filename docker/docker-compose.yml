x-shared-env: &shared-env
  TZ: ${HOST_TZ:-Europe/Moscow}
  LANG: ${HOST_LOCALE:-ru_RU.UTF-8}
  LC_ALL: ${HOST_LOCALE:-ru_RU.UTF-8}
  GIT_USER_NAME: ${GIT_USER_NAME:-Project Atlas}
  GIT_USER_EMAIL: ${GIT_USER_EMAIL:-dev@projectatlas.local}

x-code-volume: &code-volume
  type: bind
  source: ${PROJECT_ROOT:-../}
  target: /workspace

x-project-labels: &project-labels
  com.project: projectatlas

services:
  php:
    build:
      context: ./php
      args:
        APP_UID: ${HOST_UID:-1000}
        APP_GID: ${HOST_GID:-1000}
    container_name: projectatlas-php
    working_dir: /workspace/${BACKEND_DIR:-backend}
    environment:
      <<: *shared-env
      PHP_IDE_CONFIG: serverName=ProjectAtlas
      COMPOSER_MEMORY_LIMIT: -1
      XDEBUG_MODE: "off"
    volumes:
      - *code-volume
      - composer_cache:/home/dev/.composer
    ports:
      - "${PHP_FPM_PORT:-9000}:9000"
    networks:
      - atlas
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      <<: *project-labels
      com.project.service: php

  frontend:
    build:
      context: ./node
      args:
        APP_UID: ${HOST_UID:-1000}
        APP_GID: ${HOST_GID:-1000}
    container_name: projectatlas-frontend
    working_dir: /workspace/${FRONTEND_DIR:-frontend}
    environment:
      <<: *shared-env
      VITE_PORT: ${VITE_PORT:-5173}
    volumes:
      - *code-volume
      - frontend_node_modules:/workspace/${FRONTEND_DIR:-frontend}/node_modules
    command: >-
      sh -c "if [ -f package.json ]; then npm install && npm run dev -- --host 0.0.0.0 --port ${VITE_PORT:-5173}; else echo 'frontend directory is empty - waiting for sources'; tail -f /dev/null; fi"
    ports:
      - "${VITE_PORT:-5173}:5173"
    networks:
      - atlas
    depends_on:
      - php
    labels:
      <<: *project-labels
      com.project.service: frontend

  nginx:
    image: nginx:1.27-alpine
    container_name: projectatlas-nginx
    depends_on:
      - php
      - frontend
    volumes:
      - *code-volume
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "${NGINX_PORT:-80}:80"
    environment:
      <<: *shared-env
    networks:
      - atlas
    labels:
      <<: *project-labels
      com.project.service: nginx

networks:
  atlas:
    driver: bridge

volumes:
  composer_cache:
    labels:
      <<: *project-labels
      com.project.volume: composer_cache
  frontend_node_modules:
    labels:
      <<: *project-labels
      com.project.volume: frontend_node_modules
